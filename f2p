#!/usr/bin/env python3

import argparse
import os
import sys

def is_text_file(filepath):
    try:
        with open(filepath, 'rb') as f:
            chunk = f.read(1024)
            chunk.decode('utf-8')  # try decoding to check if it's text
        return True
    except UnicodeDecodeError:
        return False
    except Exception as e:
        print(f"Error reading file {filepath}: {e}", file=sys.stderr)
        return False

def find_all_text_files():
    text_files = []
    for root, dirs, files in os.walk('.'):
        dirs[:] = [d for d in dirs if d != '.git']  # Skip .git/
        for filename in files:
            full_path = os.path.join(root, filename)
            if os.path.isfile(full_path) and is_text_file(full_path):
                text_files.append(full_path)
    return sorted(text_files)  # Sort alphabetically

def main():
    parser = argparse.ArgumentParser(
        usage="""

    f2p

or:

    f2p [FILE ...]
""",
        description=(
"""
Output the contents of text files to STDOUT.

If run without arguments, it outputs all text files in
the current directory (recursively), excluding files under .git/

If run with one or more FILE arguments, it outputs only those files.
"""
        ),
        formatter_class=argparse.RawDescriptionHelpFormatter
    )

    parser.add_argument('files', nargs='*', metavar='FILE',
                        help='Only output the specified file(s)')

    args = parser.parse_args()

    if args.files:
        for filepath in args.files:
            if not os.path.exists(filepath):
                print(f"Error: File does not exist: {filepath}", file=sys.stderr)
                sys.exit(1)
            if not os.path.isfile(filepath):
                print(f"Error: Not a file: {filepath}", file=sys.stderr)
                sys.exit(1)
            if not is_text_file(filepath):
                print(f"Error: File is not a text file: {filepath}", file=sys.stderr)
                sys.exit(1)

    else:
        args.files = find_all_text_files()
        if not args.files:
            print("Error: No text files found", file=sys.stderr)
            sys.exit(1)

        # Sort auto-found list
        args.files = sorted(args.files)

    total_lines = 0
    total_files = len(args.files)

    for filepath in args.files:
        print(f"## File `{os.path.relpath(filepath)}`")
        print()

        with open(filepath, "r", encoding="utf-8") as f:
            for line in f:
                print(line, end="")
                total_lines += 1
        print()
        total_lines += 3

    plural_f = "s" if total_files != 1 else ""
    plural_l = "s" if total_lines != 1 else ""
    print(f"{total_files} file{plural_f}, {total_lines} line{plural_l}", file=sys.stderr)

if __name__ == '__main__':
    main()
